name: ğŸ›¡ï¸ VerificaciÃ³n de Backups Diaria

on:
  schedule:
    # Ejecutar todos los dÃ­as a las 2:00 AM UTC (9:00 PM Colombia)
    - cron: '0 2 * * *'
  workflow_dispatch: # Permitir ejecuciÃ³n manual
  
  # TambiÃ©n ejecutar en cambios que afecten backups
  push:
    paths:
      - 'BACKUP_*'
      - 'restore_backup.sh'
      - '.github/workflows/backup-verification.yml'

jobs:
  verify-backup-integrity:
    runs-on: ubuntu-latest
    name: Verificar Integridad de Backups
    
    steps:
    - name: ğŸ“¦ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: ğŸ“‹ Instalar dependencias
      run: npm ci
      
    - name: ğŸ” AnÃ¡lisis completo de backups
      run: |
        echo "ğŸ›¡ï¸ === VERIFICACIÃ“N COMPLETA DE BACKUPS ==="
        echo "Fecha: $(date)"
        echo "Commit: $GITHUB_SHA"
        echo "Rama: $GITHUB_REF_NAME"
        echo ""
        
        # Verificar archivos de cÃ³digo crÃ­ticos
        echo "ğŸ“‚ Verificando archivos de cÃ³digo de backup..."
        CODE_BACKUPS=(
          "BACKUP_ver_reclutamiento_ESTABLE.tsx"
          "BACKUP_AgregarParticipanteModal_ESTABLE.tsx"
          "BACKUP_AsignarAgendamientoModal_ESTABLE.tsx"
          "BACKUP_actualizar_estados_ESTABLE.ts"
          "BACKUP_participantes_reclutamiento_ESTABLE.ts"
        )
        
        for file in "${CODE_BACKUPS[@]}"; do
          if [ -f "$file" ]; then
            SIZE=$(wc -l < "$file")
            echo "âœ… $file ($SIZE lÃ­neas)"
            
            # Verificar que no estÃ© vacÃ­o y tenga contenido vÃ¡lido
            if [ $SIZE -lt 10 ]; then
              echo "âš ï¸  ADVERTENCIA: $file parece muy pequeÃ±o ($SIZE lÃ­neas)"
            fi
          else
            echo "âŒ $file - NO ENCONTRADO"
            exit 1
          fi
        done
        
        echo ""
        echo "ğŸ“‹ Verificando documentaciÃ³n de backup..."
        DOC_BACKUPS=(
          "BACKUP_ESTADO_ACTUAL_PLATAFORMA.md"
          "BACKUP_INSTRUCCIONES_RESTAURACION.md"
          "BACKUP_CONFIGURACION_SISTEMA.md"
          "BACKUP_COMANDOS_CRITICOS.md"
          "BACKUP_ESTRUCTURA_DIRECTORIOS.md"
          "BACKUP_RESUMEN_FINAL.md"
        )
        
        for file in "${DOC_BACKUPS[@]}"; do
          if [ -f "$file" ]; then
            SIZE=$(wc -l < "$file")
            echo "âœ… $file ($SIZE lÃ­neas)"
          else
            echo "âŒ $file - NO ENCONTRADO"
            exit 1
          fi
        done
        
        echo ""
        echo "ğŸ”§ Verificando script de restauraciÃ³n..."
        if [ -f "restore_backup.sh" ]; then
          if [ -x "restore_backup.sh" ]; then
            SIZE=$(wc -l < "restore_backup.sh")
            echo "âœ… restore_backup.sh ($SIZE lÃ­neas, ejecutable)"
            
            # Verificar sintaxis del script
            bash -n restore_backup.sh && echo "âœ… Sintaxis del script vÃ¡lida" || echo "âŒ Error de sintaxis en script"
          else
            echo "âš ï¸  restore_backup.sh existe pero no es ejecutable"
            chmod +x restore_backup.sh
            echo "âœ… Permisos de ejecuciÃ³n corregidos"
          fi
        else
          echo "âŒ restore_backup.sh - NO ENCONTRADO"
          exit 1
        fi
        
    - name: ğŸ§ª Probar funciones de verificaciÃ³n del script
      run: |
        echo "ğŸ§ª Probando funcionalidades del script de restauraciÃ³n..."
        
        # Probar modo check (sin hacer cambios)
        if ./restore_backup.sh check; then
          echo "âœ… Comando 'check' ejecutado correctamente"
        else
          echo "âš ï¸ Comando 'check' completÃ³ con advertencias (normal en CI)"
        fi
        
    - name: ğŸ“Š Generar reporte de estado
      run: |
        echo "ğŸ“Š === REPORTE DE ESTADO DE BACKUPS ===" >> backup_report.txt
        echo "Fecha: $(date)" >> backup_report.txt
        echo "Commit: $GITHUB_SHA" >> backup_report.txt
        echo "Rama: $GITHUB_REF_NAME" >> backup_report.txt
        echo "" >> backup_report.txt
        
        echo "Archivos de backup verificados:" >> backup_report.txt
        find . -name "BACKUP_*" -type f | wc -l >> backup_report.txt
        echo "" >> backup_report.txt
        
        echo "TamaÃ±os de archivos crÃ­ticos:" >> backup_report.txt
        ls -lh BACKUP_* | grep -E "\.(tsx|ts|md)$" >> backup_report.txt
        
        echo "âœ… Reporte generado en backup_report.txt"
        cat backup_report.txt
        
    - name: ğŸ“¤ Subir reporte de verificaciÃ³n
      uses: actions/upload-artifact@v4
      with:
        name: backup-verification-report
        path: backup_report.txt
        retention-days: 30
        
    - name: ğŸ¯ VerificaciÃ³n completada
      run: |
        echo "ğŸ‰ VerificaciÃ³n de backups completada exitosamente"
        echo "ğŸ“ Todos los archivos crÃ­ticos estÃ¡n presentes y accesibles"
        echo "ğŸ›¡ï¸ Los backups estÃ¡n listos para restauraciÃ³n si es necesario"

  # Job adicional: Verificar que los backups sean restaurables
  test-backup-restoration:
    runs-on: ubuntu-latest
    name: Probar RestauraciÃ³n de Backups
    needs: verify-backup-integrity
    
    steps:
    - name: ğŸ“¦ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: ğŸ“‹ Instalar dependencias
      run: npm ci
      
    - name: ğŸ§ª Simular restauraciÃ³n de archivos crÃ­ticos
      run: |
        echo "ğŸ§ª Simulando proceso de restauraciÃ³n..."
        
        # Crear directorio temporal para simular restauraciÃ³n
        mkdir -p test_restore/src/pages/reclutamiento/ver/
        mkdir -p test_restore/src/components/ui/
        mkdir -p test_restore/src/pages/api/
        
        # Simular restauraciÃ³n de archivos crÃ­ticos
        echo "ğŸ“‚ Copiando archivos de backup a ubicaciones temporales..."
        
        if cp BACKUP_ver_reclutamiento_ESTABLE.tsx test_restore/src/pages/reclutamiento/ver/\[id\].tsx 2>/dev/null; then
          echo "âœ… Vista de reclutamiento restaurable"
        else
          echo "âŒ Error restaurando vista de reclutamiento"
          exit 1
        fi
        
        if cp BACKUP_AgregarParticipanteModal_ESTABLE.tsx test_restore/src/components/ui/AgregarParticipanteModal.tsx; then
          echo "âœ… Modal agregar participante restaurable"
        else
          echo "âŒ Error restaurando modal agregar participante"
          exit 1
        fi
        
        if cp BACKUP_AsignarAgendamientoModal_ESTABLE.tsx test_restore/src/components/ui/AsignarAgendamientoModal.tsx; then
          echo "âœ… Modal asignar agendamiento restaurable"
        else
          echo "âŒ Error restaurando modal asignar agendamiento"
          exit 1
        fi
        
        if cp BACKUP_actualizar_estados_ESTABLE.ts test_restore/src/pages/api/actualizar-estados-reclutamiento.ts; then
          echo "âœ… API actualizar estados restaurable"
        else
          echo "âŒ Error restaurando API actualizar estados"
          exit 1
        fi
        
        if cp BACKUP_participantes_reclutamiento_ESTABLE.ts test_restore/src/pages/api/participantes-reclutamiento.ts; then
          echo "âœ… API participantes reclutamiento restaurable"
        else
          echo "âŒ Error restaurando API participantes"
          exit 1
        fi
        
        echo ""
        echo "ğŸ‰ SimulaciÃ³n de restauraciÃ³n completada exitosamente"
        echo "ğŸ“Š Archivos verificados: $(find test_restore -name "*.tsx" -o -name "*.ts" | wc -l)"
        
        # Limpiar archivos temporales
        rm -rf test_restore/
        echo "ğŸ§¹ Archivos temporales limpiados"